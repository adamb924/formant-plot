<!doctype html>
<html>
<head>
<title>Formant Plot</title>
<meta charset="utf-8"/>
<script type="text/javascript" src="jquery-2.1.0.min.js"></script>
<script type="text/javascript" src="jquery-ui-1.11.0.custom/jquery-ui.js"></script>
<link rel="stylesheet" href="jquery-ui-1.11.0.custom/jquery-ui.css" />
<link rel="stylesheet" media="screen" type="text/css" href="colorpicker/css/colorpicker.css" />
<link rel="stylesheet" media="screen" type="text/css" href="formant-chart.css" />
<script type="text/javascript" src="raphael-min.js"></script>
<script type="text/javascript" src="raphael.export.js"></script>
<script type="text/javascript" src="colorpicker/js/colorpicker.js"></script>
<script>

// http://stackoverflow.com/questions/4224359/making-paths-and-images-dragable-in-raphael-js

var start = function () {
  this.odx = 0;
  this.ody = 0;
  this.animate({"fill-opacity": 0.2}, 500);
},
move = function (dx, dy) {
  this.translate(dx - this.odx, dy - this.ody);
  this.odx = dx;
  this.ody = dy;
},
up = function () {
    this.animate({"fill-opacity": 1}, 500);
};

function FormantChart(parameters,elementId) {
	this.p = parameters;
    this.elementId = elementId;
    
	this.draw = function() {
		$('svg').remove();
		
		$('#' + this.elementId ).width( this.p.figWidth );

        this.paper = Raphael(this.elementId, this.p.figWidth, this.p.figHeight );

        this.drawTrapezoid();
        this.drawHorizontalLines();
        this.drawVerticalLines();
        for(var i=0; i<this.data.length; i++) {
            this.plotPoint( this.data[i][1], this.data[i][2], this.data[i][0] );
        }
    }
	
	this.toSvg = function() {
		var svgCode = this.paper.toSVG();
		a = document.createElement('a');
		a.download = 'mySvg.svg';
		a.type = 'image/svg+xml';
		blob = new Blob([svgCode], {"type": "image/svg+xml"});
		a.href = (window.URL || webkitURL).createObjectURL(blob);
		a.click();
	}

	this.drawTrapezoid = function() {
        var command = "M" + this.plotLeft() + "," + this.plotTop() +
                        "H" + this.plotRight() +
                        "V" + this.plotBottom() +
                        "H" + (this.plotRight() - this.p.trapezoidRatio * this.plotWidth()) +
                        "L" + this.plotLeft() + "," + this.plotTop();
        var p = this.paper.path(command);
        p.attr("stroke-width" , this.p.trapezoidLineWidth );
        p.attr("stroke", this.p.trapezoidLineColor );
	}

	this.drawHorizontalLines = function() {
        var intervalSize = this.plotHeight() / (1 + this.p.horizontalLines);
        for(var i=1; i<=this.p.horizontalLines; i++) {
            var y = i*intervalSize;
            var right = this.plotRight();
            var left = this.plotLeft() + y * ( (1-this.p.trapezoidRatio) * this.plotWidth() ) / this.plotHeight();
            var command = "M" + right + "," + (this.plotTop() + y) +
                            "L" + left + "," + (this.plotTop() + y);
            var p = this.paper.path(command);
            p.attr("stroke-width", this.p.gridLineWidth );
            p.attr("stroke", this.p.gridLineColor );
        }
	}

	this.drawVerticalLines = function() {
        var intervalSize = this.plotWidth() / (1 + this.p.verticalLines);
        for(var i=1; i<=this.p.verticalLines; i++) {
            var command = "M" + (this.plotRight() - i*intervalSize) + "," + this.plotTop() +
                            "L" + (this.plotRight() - i*intervalSize*this.p.trapezoidRatio) + "," + this.plotBottom();
            var p = this.paper.path(command);
            p.attr("stroke-width", this.p.gridLineWidth );
            p.attr("stroke", this.p.gridLineColor );
        }
	}

	this.plotPoint = function(f1, f2, label) {
        x = this.positionX(f2);
        y = this.positionY(f1);
        if( this.p.markType == "labeled-dot" ) {
            this.drawDot( x, y );
            this.drawText( x+2*this.p.dotRadius, y-2*this.p.dotRadius, label, true );
        } else if( this.p.markType == "label-only" ) {
            this.drawText( x+2*this.p.dotRadius, y-2*this.p.dotRadius, label, false );
        } else if( this.p.markType == "dot-only" ) {
            this.drawDot( x, y );
        }
    }
    
    this.drawDot = function(x, y) {
        var d = this.paper.circle( x, y , this.p.dotRadius );
        d.attr("fill", this.p.dotFillColor );
        d.attr("stroke-width", 0 );
    }
    
    this.drawText = function(x, y, label, startAnchor) {
        var t = this.paper.text(x, y, label);
        if( startAnchor == true ) {
            t.attr("text-anchor","start");
        }
        t.attr("font-family", this.p.fontFamily );
        t.attr("font-size", this.p.fontSize );
        t.node.setAttribute("class", "draggable"); 
        t.drag(move, start, up);
    }

	this.positionY = function(f1) {
		return this.plotTop() + this.plotHeight()*(f1 - this.p.f1Min)/(this.p.f1Max - this.p.f1Min);
	}
	
	this.positionX = function(f2) {
		return this.plotRight() - this.plotWidth()*(f2 - this.p.f2Min)/(this.p.f2Max - this.p.f2Min);
	}
    
    this.plotLeft = function() {
        return this.p.figMargin;
    }
    
    this.plotRight = function() {
        return this.p.figWidth - this.p.figMargin;
    }
    
    this.plotTop = function() {
        return this.p.figMargin;
    }
    
    this.plotWidth = function() {
        return this.p.figWidth - 2 * this.p.figMargin;
    }
    
    this.plotHeight = function() {
        return this.p.figHeight - 2 * this.p.figMargin;
    }
    
    this.plotBottom = function() {
        return this.p.figHeight - this.p.figMargin;
    }
    
	this.removeFormantLimits = function() {
            delete this.p.f1Max;
            delete this.p.f2Max;
            delete this.p.f1Min;
            delete this.p.f2Min;
	}
    
    this.minimax = function() {
        if( !( this.p.hasOwnProperty("f1Max") && this.p.hasOwnProperty("f2Max") && this.p.hasOwnProperty("f1Min") && this.p.hasOwnProperty("f2Min") ) ) {
            maxF1 = Math.max.apply(Math, this.data.map(function(v) {
              return v[1];
                }));

            maxF2 = Math.max.apply(Math, this.data.map(function(v) {
              return v[2];
                }));

            minF1 = Math.min.apply(Math, this.data.map(function(v) {
              return v[1];
                }));

            minF2 = Math.min.apply(Math, this.data.map(function(v) {
              return v[2];
                }));
            
            multiplier = 0.1;
            F1range = maxF1 - minF1;
            F2range = maxF2 - minF2;
            this.p.f1Max = Math.round( maxF1 + multiplier*F1range );
            this.p.f2Max = Math.round( maxF2 + multiplier*F2range );
            this.p.f1Min = Math.round( minF1 - multiplier*F1range );
            this.p.f2Min = Math.round( minF2 - multiplier*F2range );
        }
    }
    
    this.setData = function(data) {
        if( toType(data) == "string" ) {
            this.data = parseStringTable(data);
        } else {
            this.data = data;
        }
        this.minimax();
        this.draw();
    }
	
    parseStringTable = function(plainText) {
        var dataTable = [];
        var lines = plainText.trim().split(/[\n\r]/);
        for(var i=0; i<lines.length; i++) {
            var elements = lines[i].trim().split("\t");
            dataTable.push( [ elements[0] , elements[1], elements[2] ] );
        }
        return dataTable;
    }
    
    /// utility functions
    toType = function(obj) {
      return ({}).toString.call(obj).match(/\s([a-zA-Z]+)/)[1].toLowerCase()
    }
}

$( document ).ready(function() {

var chart = new FormantChart({
	figWidth: 600,
	figHeight: 400,
	figMargin: 10,
	trapezoidRatio: 0.7,
	horizontalLines: 2,
	verticalLines: 1,
	dotRadius: 2,
	dotFillColor: "#000000",
	fontSize: 15,
	fontFamily: "Charis SIL",
	markType: "labeled-dot",
//    markType: "label-only",
//    markType: "dot-only",
	gridLineColor: "#aaaaaa",
	gridLineWidth: 1,
	trapezoidLineColor: "#000000",
	trapezoidLineWidth: 2,
	}, "canvas");
chart.setData( $("#formant-values").val() );

$( "#tabs" ).tabs();
	
$( "#generate-button" )
	.button()
		.click(function() {
            chart.setData( $("#formant-values").val() );
            return false;
		});

$( "#download-button" )
	.button()
		.click(function() {
			var svgCode = chart.paper.toSVG();
			blob = new Blob([svgCode], {"type": "image/svg+xml"});
			$("#download-form").attr("action", (window.URL || webkitURL).createObjectURL(blob) );
		});

$( "#min-max" )
	.button()
		.click(function() {
            chart.removeFormantLimits();
            chart.minimax();
            setGuiElementsFromData(chart);
            chart.draw();
		});

function reciprocalBind(first,second) {
	$(first).bind("change", function() {
		$(second).val($(this).val());
	});

	$(second).bind("change", function() {
		$(first).val($(this).val());
	});
}

$('#intermediateLineColor').ColorPicker({
	color: '#aaaaaa',
	onShow: function (colpkr) {
		$(colpkr).fadeIn(500);
		return false;
	},
	onHide: function (colpkr) {
		$(colpkr).fadeOut(500);
		return false;
	},
	onChange: function (hsb, hex, rgb) {
		chart.p.gridLineColor = "#" + hex;
        chart.draw();
	}
});

$('#trapezoidLineColor').ColorPicker({
	color: '#aaaaaa',
	onShow: function (colpkr) {
		$(colpkr).fadeIn(500);
		return false;
	},
	onHide: function (colpkr) {
		$(colpkr).fadeOut(500);
		return false;
	},
	onChange: function (hsb, hex, rgb) {
		chart.p.trapezoidLineColor = "#" + hex;
        chart.draw();
	}
});

$('#dotColor').ColorPicker({
	color: '#000000',
	onShow: function (colpkr) {
		$(colpkr).fadeIn(500);
		return false;
	},
	onHide: function (colpkr) {
		$(colpkr).fadeOut(500);
		return false;
	},
	onChange: function (hsb, hex, rgb) {
		chart.p.dotFillColor = "#" + hex;
        chart.draw();
	}
});

reciprocalBind("#hlines-slider","#hlines-number");
reciprocalBind("#vlines-slider","#vlines-number");
reciprocalBind("#trapezoid-slider","#trapezoid-number");
reciprocalBind("#intermediateLineWidth-slider","#intermediateLineWidth-number");
reciprocalBind("#trapezoidLineWidth-slider","#trapezoidLineWidth-number");
reciprocalBind("#dotRadius-slider","#dotRadius-number");
reciprocalBind("#waWidth-slider","#waWidth-number");
reciprocalBind("#waAspect-slider","#waAspect-number");
reciprocalBind("#absWidth-slider","#absWidth-number");
reciprocalBind("#absHeight-slider","#absHeight-number");
reciprocalBind("#margin-slider","#margin-number");

$("#hlines-slider, #hlines-number").bind("change", function() {
	chart.p.horizontalLines = parseInt( $(this).val() );
	chart.draw();
});

$("#vlines-slider, #vlines-number").bind("change", function() {
	chart.p.verticalLines = parseInt( $(this).val() );
	chart.draw();
});

$("#trapezoid-slider, #trapezoid-number").bind("change", function() {
	chart.p.trapezoidRatio = parseFloat( $(this).val() );
	chart.draw();
});

$("#intermediateLineWidth-slider, #intermediateLineWidth-number").bind("change", function() {
	chart.p.gridLineWidth = parseFloat( $(this).val() );
	chart.draw();
});

$("#trapezoidLineWidth-slider, #trapezoidLineWidth-number").bind("change", function() {
	chart.p.trapezoidLineWidth = parseFloat( $(this).val() );
	chart.draw();
});

$("#fontFamily").bind("change", function() {
	chart.p.fontFamily = $(this).val();
	chart.draw();
});

$("#fontSize").bind("change", function() {
	chart.p.fontSize = parseInt($(this).val());
	chart.draw();
});

$("#markType").bind("change", function() {
	chart.p.markType = $(this).val();
	chart.draw();
});

$("#dotRadius-slider, #dotRadius-number").bind("change", function() {
	chart.p.dotRadius = parseFloat( $(this).val() );
	chart.draw();
});
    
$("#margin-slider, #margin-number").bind("change", function() {
	chart.p.figMargin = parseFloat( $(this).val() );
	chart.draw();
});
    

$("#waWidth-slider, #waWidth-number").bind("change", function() {
    var width = parseFloat( $(this).val() );
    var aspect = parseFloat( $("#waAspect-number").val() );
	chart.p.figWidth = width;
    chart.p.figHeight = width * aspect;
    $("#absWidth-slider, #absWidth-number").val( Math.round(width) );
    $("#absHeight-slider, #absHeight-number").val( Math.round(width * aspect) );
	chart.draw();
});
   
$("#waAspect-slider, #waAspect-number").bind("change", function() {
    var width = parseFloat( $("#waWidth-number").val() );
    var aspect = parseFloat( $(this).val() );
	chart.p.figWidth = width;
    chart.p.figHeight = width * aspect;
    $("#absWidth-slider, #absWidth-number").val( Math.round(width) );
    $("#absHeight-slider, #absHeight-number").val( Math.round(width * aspect) );
	chart.draw();
});
 
$("#absWidth-slider, #absWidth-number").bind("change", function() {
	chart.p.figWidth = parseFloat( $(this).val() );
    $("#waWidth-slider, #waWidth-number").val(chart.p.figWidth);
	var aspect = chart.p.figHeight / chart.p.figWidth;
	aspect = Math.round( aspect*100 ) / 100;
    $("#waAspect-slider, #waAspect-number").val(aspect);
	chart.draw();
});
 
 
$("#absHeight-slider, #absHeight-number").bind("change", function() {
	chart.p.figHeight = parseFloat( $(this).val() );
    $("#waWidth-slider, #waWidth-number").val(chart.p.figWidth);
	var aspect = chart.p.figHeight / chart.p.figWidth;
	aspect = Math.round( aspect*100 ) / 100;
    $("#waAspect-slider, #waAspect-number").val(aspect);
	chart.draw();
});


$("#formant-values").bind("change", function() {
	chart.removeFormantLimits();
    chart.setData( $(this).val() );
});


$("#f1min").bind("change", function() {
	chart.p.f1Min = $(this).val();
	chart.draw();
});

$("#f1max").bind("change", function() {
	chart.p.f1Max = $(this).val();
	chart.draw();
});

$("#f2min").bind("change", function() {
	chart.p.f2Min = $(this).val();
	chart.draw();
});

$("#f2max").bind("change", function() {
	chart.p.f2Max = $(this).val();
	chart.draw();
});


$( "#accordion" ).accordion({ autoHeight: false });
    
function setGuiElementsFromData(chart) {
    $('#trapezoid-slider').val( chart.p.trapezoidRatio );
    $('#trapezoid-number').val( chart.p.trapezoidRatio );
    $('#trapezoidLineColor').ColorPickerSetColor( chart.p.trapezoidLineColor.replace("#","") );
    $('#trapezoidLineColor').val( chart.p.trapezoidLineColor.replace("#","") );
    $('#trapezoidLineWidth-slider').val( chart.p.trapezoidLineWidth );
    $('#trapezoidLineWidth-number').val( chart.p.trapezoidLineWidth );
    $('#hlines-slider').val( chart.p.horizontalLines );
    $('#hlines-number').val( chart.p.horizontalLines );
    $('#vlines-slider').val( chart.p.verticalLines );
    $('#vlines-number').val( chart.p.verticalLines );
    $('#intermediateLineColor').ColorPickerSetColor( chart.p.gridLineColor.replace("#","") );
    $('#intermediateLineColor').val( chart.p.gridLineColor.replace("#","") );
    $('#intermediateLineWidth-slider').val( chart.p.gridLineWidth );
    $('#intermediateLineWidth-number').val( chart.p.gridLineWidth );
    $('#waWidth-slider').val( chart.p.figWidth );
    $('#waWidth-number').val( chart.p.figWidth );
    $('#waAspect-slider').val( Math.round(chart.p.figHeight/chart.p.figWidth*100)/100 );
    $('#waAspect-number').val( Math.round(chart.p.figHeight/chart.p.figWidth*100)/100 );
    $('#absWidth-slider').val( chart.p.figWidth );
    $('#absWidth-number').val( chart.p.figWidth );
    $('#absHeight-slider').val( chart.p.figHeight );
    $('#absHeight-number').val( chart.p.figHeight );
    $('#margin-slider').val( chart.p.figMargin );
    $('#margin-number').val( chart.p.figMargin );
    $('#f1min').val( chart.p.f1Min );
    $('#f1max').val( chart.p.f1Max );
    $('#f2min').val( chart.p.f2Min );
    $('#f2max').val( chart.p.f2Max );
    $('#markType').val( chart.p.markType );
    $('#fontFamily').val( chart.p.fontFamily );
    $('#fontSize').val( chart.p.fontSize );
    $('#dotColor').ColorPickerSetColor( chart.p.dotFillColor.replace("#","") );
    $('#dotColor').val( chart.p.dotFillColor.replace("#","") );
    $('#dotRadius-slider').val( chart.p.dotRadius );
    $('#dotRadius-number').val( chart.p.dotRadius );
}
    
setGuiElementsFromData(chart);

// end of onReady
});

</script>
</head>
<body>

<div id="control-panel">
<h1>Formant Plot</h1>


<div id="tabs">
<ul>
<li><a href="#tabs-1">Grid</a></li>
<li><a href="#tabs-2">Limits</a></li>
<li><a href="#tabs-3">Marks</a></li>
</ul>
<div id="tabs-1">
    <fieldset>
        <legend>Trapezoid</legend>
        <label for="trapezoid-slider">Trapezoid Ratio</label>
        <input type="range" id="trapezoid-slider" min="0" max="1" step="0.01" value="0.7"/>
        <input type="number" id="trapezoid-number" min="0" max="1" step="0.01" value="0.7"/>
        <br/>
        <label for="trapezoidLineColor">Line Color</label>
        <input type="text" maxlength="6" size="6" id="trapezoidLineColor" value="aaaaaa" />
        <br/>
        <label for="trapezoidLineWidth-slider">Line Width</label>
        <input type="range" id="trapezoidLineWidth-slider" min="0" max="10" step="0.1" value="1"/>
        <input type="number" id="trapezoidLineWidth-number" min="0" max="10" step="0.1" value="1"/>
    </fieldset>
    <fieldset>
        <legend>Intermediate Lines</legend>
        <label for="hlines-slider">Horizontal</label>
        <input type="range" id="hlines-slider" min="0" max="10" step="1" value="2"/>
        <input type="number" id="hlines-number" min="0" max="10" step="1" value="2"/>
        <br/>
        <label for="vlines-slider">Vertical</label>
        <input type="range" id="vlines-slider" min="0" max="10" step="1" value="1"/>
        <input type="number" id="vlines-number" min="0" max="10" step="1" value="1"/>
        <br/>
        <label for="intermediateLineColor">Line Color</label>
        <input type="text" maxlength="6" size="6" id="intermediateLineColor" value="aaaaaa" />
        <br/>
        <label for="intermediateLineWidth-slider">Line Width</label>
        <input type="range" id="intermediateLineWidth-slider" min="0" max="10" step="0.1" value="1"/>
        <input type="number" id="intermediateLineWidth-number" min="0" max="10" step="0.1" value="1"/>
    </fieldset>

</div>
<div id="tabs-2">
    <div id="accordion">
        <h3>Width &amp; Aspect Ratio</h3>
        <div>
            <label for="waWidth-slider">Width</label>
            <input type="range" id="waWidth-slider" min="1" max="1000" step="1" value="600"/>
            <input type="number" id="waWidth-number" min="1" max="10000" step="1" value="600"/>
            <br/>
            <label for="waAspect-slider">Aspect Ratio</label>
            <input type="range" id="waAspect-slider" min="0" max="1" step="0.01" value="0.62"/>
            <input type="number" id="waAspect-number" min="0" max="1" step="0.01" value="0.62"/>
        </div>
        <h3>Absolute Dimensions</h3>
        <div>
            <label for="absWidth-slider">Width</label>
            <input type="range" id="absWidth-slider" min="1" max="1000" step="1" value="600"/>
            <input type="number" id="absWidth-number" min="1" max="1000" step="1" value="600"/>
            <br/>
            <label for="absHeight-slider">Height</label>
            <input type="range" id="absHeight-slider" min="1" max="1000" step="1" value="400"/>
            <input type="number" id="absHeight-number" min="1" max="1000" step="1" value="400"/>
            <br/>
        </div>
    </div>
    <fieldset>
        <legend>Figure</legend>
        <label for="margin-slider">Margin</label>
        <input type="range" id="margin-slider" min="1" max="50" step="1" value="10"/>
        <input type="number" id="margin-number" min="1" max="50" step="1" value="10"/>
        <br/>
        <label for="f1min">F1 Min/Max</label>
        <input type="number" id="f1min" min="1" max="6000" step="1" value="100"/>
        <input type="number" id="f1max" min="1" max="6000" step="1" value="100"/>
        <br/>
        <label for="f2min">F2 Min/Max</label>
        <input type="number" id="f2min" min="1" max="6000" step="1" value="100"/>
        <input type="number" id="f2max" min="1" max="6000" step="1" value="100"/>
        <br/>
        <button id="min-max">Recalculate Min/Max</button>
    </fieldset>
</div>
<div id="tabs-3">
    <label for="markType">Marker Type</label>
    <select id="markType">
        <option value="labeled-dot">Label &amp; Dot</option>
        <option value="label-only">Label Only</option>
        <option value="dot-only">Dot Only</option>
    </select>
    <fieldset>
        <legend>Text</legend>
        <label for="fontFamily">Font family</label>
        <select id="fontFamily">
            <option>Charis SIL</option>
            <option>Doulos SIL</option>
            <option>Times New Roman</option>
            <option>Arial</option>
        </select>
        <br/>
        <label for="fontSize">Font size</label>
        <input type="number" id="fontSize" min="1" value="12"/>
    </fieldset>
    <fieldset>
        <legend>Dot</legend>
        <label for="dotColor">Dot Color</label>
        <input type="text" maxlength="6" size="6" id="dotColor" value="000000" />
        <br/>
        <label for="dotRadius-slider">Dot Radius</label>
        <input type="range" id="dotRadius-slider" min="0" max="10" step="0.1" value="1"/>
        <input type="number" id="dotRadius-number" min="0" max="10" step="0.1" value="1"/>
    </fieldset>
</div>
</div>

<form action="#">
<textarea id="formant-values">
full1	533.745133	1181.353458
full2	517.707007	1193.53447
his	478.611869	2082.604608
any1	811.626238	2014.870501
any2	719.339403	1942.704448
baa1	902.860105	1414.25254
baa2	823.956934	1498.296478
baa3	806.820241	1495.961373
baa4	802.203961	1482.023626
bags1	879.074107	2008.660115
bags2	736.565623	1869.898212
black1	842.301508	1737.293637
black2	773.51436	1778.356439
have1	862.217698	1490.199498
have2	721.391571	1771.727017
master	910.326894	1704.404265
sheep1	484.030789	2467.422761
sheep2	453.397655	2459.87333
three1	415.259383	2525.472568
three2	425.54958	2566.236212
yes1	782.632441	2047.278341
yes2	683.126116	2307.450247
yes3	581.056427	2227.651981
you1	445.920299	1354.813474
you2	356.77505	1722.849763
</textarea>
</form>


<form id="download-form">
<button id="generate-button">Update</button>
<button id="download-button">Download</button>
</form>

</div>

<div id="canvas-holder">

<div id="canvas"/>

</div>

</body>
</html>